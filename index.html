
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents || "{}");

    if (!data.empleado || !data.matricula || !data.fecha) {
      return json_({ ok: false, error: "Faltan campos obligatorios." });
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sh = ss.getSheetByName("Registros") || ss.insertSheet("Registros");

    const folderName = "Fotos_DaÃ±os_Checklists";
    const folder = getOrCreateFolder_(folderName);

    const urls = [];
    const images = Array.isArray(data.images) ? data.images : [];
    images.forEach((img, idx) => {
      const parts = String(img.dataUrl || "").split(",");
      if (parts.length < 2) return;
      const b64 = parts[1];
      const bytes = Utilities.base64Decode(b64);
      const contentType = img.type || "image/jpeg";
      const ext = contentType.includes("png") ? "png" : "jpg";

      const fileName =
        `${data.fecha}_${data.matricula}_${data.empleado}_${idx + 1}.${ext}`
          .replaceAll(":", "-")
          .replaceAll(" ", "_");

      const blob = Utilities.newBlob(bytes, contentType, fileName);
      const file = folder.createFile(blob);
      urls.push(file.getUrl());
    });

    sh.appendRow([
      data.fecha,
      data.empleado,
      data.matricula,
      data.km || "",
      data.fuel || "",
      data.observaciones || "",
      JSON.stringify(data.checks || []),
      JSON.stringify(urls),
      data.userAgent || ""
    ]);

    return json_({ ok: true, savedPhotos: urls.length });
  } catch (err) {
    return json_({ ok: false, error: String(err) });
  }
}

function json_(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function getOrCreateFolder_(name) {
  const it = DriveApp.getFoldersByName(name);
  if (it.hasNext()) return it.next();
  return DriveApp.createFolder(name);
}
